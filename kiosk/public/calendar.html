<!DOCTYPE html>
<html>
  <!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
  <!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
  <!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
  <!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset='utf-8'>
    <meta content='IE=edge' http-equiv='X-UA-Compatible'>
    <title></title>
    <meta content='Gonna blow your mind. Get ready.' name='description'>
    <meta content='width=device-width' initial-scale='1' name='viewport'>
    <script src='//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js'></script>
    <link href="/stylesheets/fullcalendar.css" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/application-5a00a15f.css" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/animate-31203878.css" rel="stylesheet" type="text/css" />

    <script src='/javascripts/moment.min.js'></script>
    <script src='/javascripts/fullcalendar.min.js'></script>
    <script src='/javascripts/scheduler.min.js'></script>
    <script src='/javascripts/gcal.js'></script>
    <script src='/javascripts/jquery.touchSwipe.min.js'></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

  </head>
  <body>
  <script>
  var isMobile = window.matchMedia("only screen and (max-width: 760px)");
  var me = {};
  $.ajax({url:'/me',dataType:'json'}).done(function(d){
    me = d;
  }).fail(function(){
    // later!
    // window.location("/register");
    me={full_name:'Bill Cromie',slackname:'@billcromie'};
  });

  $( document ).ready(function() {
    $('#calendar').fullCalendar({
      header: {
        left: 'prev,next today',
        center: 'title',
        right: 'agendaWeek,agendaDay'
      },
      defaultView:'agendaDay',
      defaultDate: moment(),

      scrollTime: '09:00:00', // undo default 6am scrollTime
      eventLimit: true,
      nowIndicator: true,
      eventOverlap: false,
      slotEventOverlap: false,
      allDaySlot: false,
      schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
      groupByResource: true,
      editable:true,
      selectable: true,
      selectHelper: true,
      slotDuration:'00:15:00',
      minTime:'08:00:00',
      eventClick:  function(event, jsEvent, view) {
        console.log(event)
        $('#modalEventId').val(event.id);
        $('#modalTitle').html(event.title);
        $('#modalBody').html(event.description);
        $('#modalStart').val(event.start);
        $('#modalEnd').val(event.end);
        $('#modalCalendar').val(event.resourceId);
        $('#eventUrl').attr('href',event.url);
        $('#fullCalModal').modal();
        jsEvent.preventDefault();
      },
      // user selects times on the calendar for a new event
      select: function(start, end, event, view, res) {
        resource_select(start.format(),end.format(), res);
      },
      eventDrop:function( event, delta, revertFunc, jsEvent, ui, view ) {
        // delta is the change in milliseconds to the start of the event.
        console.log(event);


        // get event id, get new resource id, update color, update title, etc. etc.
        // send new times to backend
        // on success refresh calendar events
        // on fail call refertFunc.

      },
      eventResize: function( event, delta, revertFunc, jsEvent, ui, view ) {
        // delta is the change in milliseconds to the end of the event.

        // get event id, send new times to backend
        // on success refresh calendar events
        // on fail call refertFunc.
      },
      googleCalendarApiKey: 'AIzaSyAOzgZPmbbgrd79XHDyWu9oyhmcJaVfXv8',
      resources: [
            { id: 'tiny', title: 'Tiny' },
            { id: 'smalls', title: 'Smalls' },
            { id: 'biggie', title: 'Biggie' }
        ],
      eventSources:[
        {
          googleCalendarId: 'robinhood.org_2d37313337333130363239@resource.calendar.google.com',
          className: 'tiny',
          color: 'green',
          resourceId: 'tiny',
          editable:true
        },
        {
          googleCalendarId: 'robinhood.org_3730373137363538363534@resource.calendar.google.com',
          className: 'smalls',
          color: 'red',
          resourceId: 'smalls',
          editable:true
        },{
          googleCalendarId: 'robinhood.org_2d33313439373439322d363134@resource.calendar.google.com',
          className: 'biggie',
          color: 'blue',
          resourceId: 'biggie',
          editable:true
        }
      ],
      eventRender: function(event, element){
        if (typeof(event.source) != 'undefined' && typeof(event.source.className)!='undefined') {

          var room = event.source.className[0];
          element.find('.fc-time').append('<div class="title pull-right" >'+ room +'</div>');
        }
      }
    });
    // touch screen!!
  var isTouchDevice = 'ontouchstart' in document.documentElement;
  if( isTouchDevice ) {
    $("#calendar").swipe( {
      tap:function(event, target) {
        $(target).click();
      },
      doubleTap:function(event, target) {
        $(target).click();
      },
      longTap:function(event, target) {
        $(target).click();
      },
      swipe:function(event, direction, distance, duration, fingerCount, fingerData) {
        if (direction == 'right') { $('#calendar').fullCalendar('prev'); }
        if (direction == 'left') { $('#calendar').fullCalendar('next'); }
      },
      threshold: 50,
      fingers: 'all',
      allowPageScroll: "vertical"
    });
  }

  function resource_select(start,end,res){
    var e_id = uuid();
    var calendar =  res.id;
    var title = res.id + " - " + me.full_name;
    $('#calendar').fullCalendar('renderEvent',
      {
        id: e_id,
        title: title,
        start: start,
        end: end,
        resourceId: calendar
      },
      true // make the event "stick"
    );
    save_event_gcal(e_id,title,start,end,calendar);
    $('#calendar').fullCalendar('unselect');
  }

  // saves the event, revert on fail.
  function save_event_gcal(id,title,start,end,calendar,revertFunc) {
    var url = "/calendar";
    var data = {
      'id': id,
      'title': title,
      'start': start,
      'end': end,
      'calendar': calendar
    };

    $.post(url,data,function(responseTxt,statusTxt,xhr){
            if(statusTxt=="error") {
              alert("Error: "+xhr.status+": "+xhr.statusText);
            }
    });
  }

  function uuid() {
    // 128 character random string. Should literally never collide.
    var uuid = "", i, random;
    for (i = 0; i < 128; i++) {
      random = Math.random() * 16 | 0;
      uuid += (i == 12 ? 4 : (i == 16 ? (random & 3 | 8) : random)).toString(16);
    }
    return uuid;
  }
});
</script>
  <!-- fullcalendar  -->
  <div id="calendar"></div>

  <!--  the click modal. url to and delete;-->
  <div id="fullCalModal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">Ã—</span> <span class="sr-only">close</span></button>
                <h4 id="modalTitle" class="modal-title"></h4>
            </div>
            <div id="modalBody" class="modal-body"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button class="btn btn-primary"><a id="eventUrl" target="_blank">Event Page</a></button>
            </div>
        </div>
    </div>
</div>

  </body>
</html>
